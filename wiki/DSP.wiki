#summary This page contains all information regarding Omap3530 DSP stack integration in Android
<wiki:toc max_depth="4" />
= Introduction =

The OMAP3530 (as well the !DaVinci (DM) family of processors) has a C46x+ DSP core embedded in the SoC. This DSP core can be used for various purposes, including multimedia decoding/encoding.

[http://code.google.com/p/rowboat/ Rowboat] DSP support is based on the TI Linux Digital Video Software Development Kit ([http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/ DVSDK]) for the OMAP3530

= Software Stack Components =

The following components form a complete software stack needed to work efficiently with DSP:

TBD: _Briefly describe what each component does and provide reference to all useful information_ 

 # *bios* (and tools)
 # *codec engine* (and tools)
 # *dsplink*
 # *dmai*
 # *opencore dmai codecs* (coming soon)
 # *additional DSP codecs* (optional)
 # *ti gstreamer* (optional)

= Components/packages versions and locations =

 # [http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/3_00_02_44/exports/dvsdk_setuplinux_3_00_02_44.bin DVSDK_3_00 3_00_02_44] containing:
    # biosutils_1_01_00
    # ceutils_1.06
    # dmai_2_00_01_04
    # dsplink_1_61_03
    # local_power_manager_1_24
    # xdais_6_24
 # [http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/3_00_02_44/exports/cs1omap3530_setuplinux_1_00_01-44.bin cs1omap3530_1_00_01]
 # [http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/3_00_02_44/exports/TI-C6x-CGT-v6.0.16.1.bin cg6x_6.0.16.1]
 # [http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/3_00_02_44/exports/bios_setuplinux_5_33_06.bin bios_5_33_06]
 # [http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/3_00_02_44/exports/xdctools_setuplinux_3_15_01_59.bin xdctools_3_15_01_59]
 # [http://software-dl.ti.com/dsps/dsps_registered_sw/sdo_sb/targetcontent/CE/ce_2_24/index.html codec_engine_2_24_01] <br/> *Note:* You need to have an account on TI site (free registration)
 # (optional) Add-on codecs. For example mp3 DSP codec [http://software-dl-1.ti.com/dsps/forms/self_cert_export.html?prod_no=c64xplus_mp3dec_1_31_001_production.bin&ref_url=http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/latest/ c64xplus_mp3dec_1_31_001_production.bin]
 # (optional) [https://gstreamer.ti.com/gf/project/gstreamer_ti/frs/?action=FrsReleaseView&release_id=211 TIGStreamerPlugin 1.01.00] <br/> *Note:* Suggest to get gstreamer from the project SVN: 
    {{{ 
# svn checkout --username anonymous https://gstreamer.ti.com/svn/gstreamer_ti/trunk/gstreamer_ti 
    }}}

= List of modifications made on top of DSP stack =
 # Added SYS V IPC into bionic
 # Some 'libpthread' calls are not yet implemented in android (this moment they are commented out):
   * pthread_sigmask
   * pthread_mutexattr_settype
   * pthread_setcanceltype
   * pthread_attr_setinheritsched
 # Modified build files (Makefiles and config.bld) to adapt for Android toolchains
 # Memory holes kernel patches (TBD)
 # (optional) Patches for gstreamer in Android

*Note:* Opencore/Openmax DMAI codecs support coming (TIGSTreamerPlugin will be just a secondary option then)

= Building and Testing DSP stack =

== Preparation ==

 # Check if you have expect installed on your build host (TBD explain why it is needed)
 # Download rowboat Android (Eclair version) with integrated TI DSP stack from gitorious.org/rowboat:
    {{{ 
# repo init -u git://gitorious.org/rowboat/manifest.git -m rowboat-eclair-dsp.xml
# repo sync
    }}}
 # Download and place codec_engine_2_24_01.tar.gz under the _external/ti-dsp_ folder. Codec Engine is available [http://software-dl.ti.com/dsps/dsps_registered_sw/sdo_sb/targetcontent/CE/ce_2_24/index.html here.] <br/> *Note:* You may need to have an account on software-dl.ti.com
 # (Optional) Download and place mp3 DSP codec [http://software-dl-1.ti.com/dsps/forms/self_cert_export.html?prod_no=c64xplus_mp3dec_1_31_001_production.bin&ref_url=http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/latest/ c64xplus_mp3dec_1_31_001_production.bin] under the _external/ti-dsp_ folder. <br/> *Note:* It requires registration.
 # (Optional) Rest of the components (DVSDK and TIGStreamerPlugins) will be downloaded automatically during the build process, unless you want to use local files (previously downloaded instead in order to save time on downloads.
   * You can put pre-downloaded [http://software-dl.ti.com/dsps/dsps_public_sw/sdo_sb/targetcontent/dvsdk/DVSDK_3_00/latest/ DVSDK] under the _external/ti-dsp_ folder. Full list of necessary files looks as follows:
      * dvsdk_setuplinux_3_00_02_44.bin
      * cs1omap3530_setuplinux_1_00_01-44.bin
      * xdctools_setuplinux_3_15_01_59.bin
      * bios_setuplinux_5_33_06.bin
      * TI-C6x-CGT-v6.0.16.1.bin
   * TIGStreamerPlugins need to be placed under the _external/ti-dsp_ folder (assume revision 506 is taken from [https://gstreamer.ti.com/svn/gstreamer_ti/trunk/gstreamer_ti gstreamer-ti svn]). To check out it manually:
   {{{
# svn checkout -r 506 --username anonymous --password "" -q https://gstreamer.ti.com/svn/gstreamer_ti/trunk/gstreamer_ti
   }}}

== Build ==

To build Android with TI DSP stack use following command:
   {{{
# ./prepare
# make TARGET_PRODUCT=[omap3evm | beagleboard] [BUILD_WITH_GST=true] dvsdk
   }}}

It builds Android and Linux kernel for the selected platform, TI kernel modules for DSP communication and codec server.

*Hint*: It will try to download DVSDK and TIGStremear Plugins unless they are already located under _external/ti-dsp_
        
After build is finished successfully TI DSP specific kernel modules and codec server are located under the _/system/ti-dsp_ folder in the rootfs, TIGSTreamer plugin is located under the _/system/plugins_ folder in the rootfs.

== Boot ==

DVSDK DSP stack by default uses physical memory window within 89-128MB. In order not to change DSP stack mappings we recommend to use following memory settings:
  * Boards with > 128MB of memory (say Beagle C3, or OMAP3EVM Gen. II). Use "memory hole" parameters, for example adding: {{{ mem=88M@0x80000000 mem=128M@0x88000000 }}} to the bootargs tells kernel to take first 88M of phys memory and 128M with 128M offset, so the DSP memory window will not be managed by the kernel.
(Don't forget to adjust these parameters for your board)

  * Boards with 128MB of memory.Add {{{ mem=88M }}} to your bootargs (rest will be used for DSP). With 128MB board you'll probably have buffer allocating problem with the omap_vout driver. To avoid this, try following bootargs additions for the display driver:
{{{ omap_vout.vid1_static_vrfb_alloc=y omap_vout.video1_numbuffers=3 omap_vout.video1_bufsize=829440 omap_vout.video2_numbuffers=0 }}}. Anyway we recommend to use new 256M boards.


== Test ==

Now you can try playback of media using gstreamer command-line programs, for example:
    {{{ 
# gst-launch-0.10 -v filesrc location=sample.264 ! TIViddec2 codecName=h264dec engineName=codecServer ! TIDmaiVideoSink videoStd=VGA videoOutput=LCD sync=false
    }}}

You can experiment with pipe parameters using following information  [http://wiki.davincidsp.com/index.php/Example_GStreamer_Pipelines information]. <br/> *Note:* Don't forget to change gst-launch to gst-launch-0.10 (there is no symlink installed by default). No need to exports of misc paths, Loadmodules.sh is also not needed

= misc notes (draft) =

One more update:

During downloading DVSDK svn may ask you something like "do you want to save this settings"(it happens after kernel build).
You should confirm it (save permanently) so it will work quietly later.

_Some updates:_
 * Now kernel will be reconfigured with the default config only if there is no kernel/.config file so: 
  # If you didn't build kernel before it will be configured with the default config and built.
  # It will rebuild kernel using your config if .config is in place (will take a few seconds if you didn't changed it).
 * DVSDK cleaning is now calling only after downloading/installing it to clean up prebuilt stuff.